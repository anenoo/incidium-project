import { createInterface } from "node:readline";
import { PassThrough } from "node:stream";
import chunk from "lodash.chunk";
function IsNotValid() {
    return {
        unwrap() {
            return { isValid: false, json: "[]" };
        },
        map() {
            return IsNotValid();
        },
    };
}
function isValid(matrix) {
    return {
        unwrap() {
            return { isValid: true, json: `[${matrix.flat(1).map(x => JSON.stringify(x)).join(', ')}]` };
        },
        map(mapper) {
            return isValid(mapper(matrix));
        },
    };
}
function passData(raw) {
    try {
        const json = JSON.parse(raw);
        if (!Array.isArray(json)) {
            return IsNotValid();
        }
        const matrixEdgeLen = Math.sqrt(json.length);
        if (!Number.isInteger(matrixEdgeLen)) {
            return IsNotValid();
        }
        return isValid(chunk(json, matrixEdgeLen));
    }
    catch (error) {
        return IsNotValid();
    }
}
function restore(matrix) {
    let top = 0;
    let right = matrix.length - 1;
    let bottom = matrix.length - 1;
    let left = 0;
    const output = Array.from(matrix, (r) => Array.from(r));
    while (left < right && top < bottom) {
        let previous = matrix[top + 1][left];
        for (let i = left; i <= right; i++) {
            const curr = matrix[top][i];
            output[top][i] = previous;
            previous = curr;
        }
        top++;
        for (let i = top; i <= bottom; i++) {
            const curr = matrix[i][right];
            output[i][right] = previous;
            previous = curr;
        }
        right--;
        for (let i = right; i >= left; i -= 1) {
            const curr = matrix[bottom][i];
            output[bottom][i] = previous;
            previous = curr;
        }
        bottom--;
        for (let i = bottom; i >= top; i -= 1) {
            const curr = matrix[i][left];
            output[i][left] = previous;
            previous = curr;
        }
        left++;
    }
    return output;
}
export function convertCSVFile(stream) {
    const rl = createInterface({
        input: stream,
        crlfDelay: Infinity,
    });
    const outStream = new PassThrough({
        decodeStrings: false,
        encoding: "utf8",
        defaultEncoding: "utf8",
    });
    function getLine(line) {
        const indexOfComma = line.indexOf(",");
        const id = line.slice(0, indexOfComma);
        const json = line.slice(indexOfComma + 1).replaceAll(/^"|"$/g, "");
        const result = passData(json).map(restore).unwrap();
        outStream.write([id, `"${result.json}"`, result.isValid].join(","));
    }
    rl.once("line", () => {
        outStream.write("id,json,is_valid");
        rl.on("line", getLine);
    });
    rl.on("close", () => outStream.end());
    return outStream;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydE1hdHJpeC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb252ZXJ0TWF0cml4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMxQyxPQUFPLEtBQUssTUFBTSxjQUFjLENBQUM7QUFTakMsU0FBUyxVQUFVO0lBQ2pCLE9BQU87UUFDTCxNQUFNO1lBQ0osT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3hDLENBQUM7UUFDRCxHQUFHO1lBQ0QsT0FBTyxVQUFVLEVBQUUsQ0FBQztRQUN0QixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxNQUFjO0lBQzdCLE9BQU87UUFDTCxNQUFNO1lBQ0osT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUMvRixDQUFDO1FBQ0QsR0FBRyxDQUFDLE1BQU07WUFDUixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxHQUFXO0lBQzNCLElBQUk7UUFDRixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3hCLE9B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QUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlSW50ZXJmYWNlIH0gZnJvbSBcIm5vZGU6cmVhZGxpbmVcIjtcbmltcG9ydCB7IFBhc3NUaHJvdWdoIH0gZnJvbSBcIm5vZGU6c3RyZWFtXCI7XG5pbXBvcnQgY2h1bmsgZnJvbSBcImxvZGFzaC5jaHVua1wiO1xuXG50eXBlIE1hdHJpeCA9IHJlYWRvbmx5IChyZWFkb25seSBzdHJpbmdbXSlbXTtcblxuaW50ZXJmYWNlIFBhcnNlTWF0cml4UmVzdWx0IHtcbiAgcmVhZG9ubHkgdW53cmFwOiAoKSA9PiB7IHJlYWRvbmx5IGlzVmFsaWQ6IGJvb2xlYW47IHJlYWRvbmx5IGpzb246IHN0cmluZyB9O1xuICByZWFkb25seSBtYXA6IChtYXBwZXI6IChtYXRyaXg6IE1hdHJpeCkgPT4gTWF0cml4KSA9PiBQYXJzZU1hdHJpeFJlc3VsdDtcbn1cblxuZnVuY3Rpb24gSXNOb3RWYWxpZCgpOiBQYXJzZU1hdHJpeFJlc3VsdCB7XG4gIHJldHVybiB7XG4gICAgdW53cmFwKCkge1xuICAgICAgcmV0dXJuIHsgaXNWYWxpZDogZmFsc2UsIGpzb246IFwiW11cIiB9O1xuICAgIH0sXG4gICAgbWFwKCkge1xuICAgICAgcmV0dXJuIElzTm90VmFsaWQoKTtcbiAgICB9LFxuICB9O1xufVxuXG5mdW5jdGlvbiBpc1ZhbGlkKG1hdHJpeDogTWF0cml4KTogUGFyc2VNYXRyaXhSZXN1bHQge1xuICByZXR1cm4ge1xuICAgIHVud3JhcCgpIHtcbiAgICAgIHJldHVybiB7IGlzVmFsaWQ6IHRydWUsIGpzb246IGBbJHttYXRyaXguZmxhdCgxKS5tYXAoeCA9PiBKU09OLnN0cmluZ2lmeSh4KSkuam9pbignLCAnKX1dYCB9O1xuICAgIH0sXG4gICAgbWFwKG1hcHBlcikge1xuICAgICAgcmV0dXJuIGlzVmFsaWQobWFwcGVyKG1hdHJpeCkpO1xuICAgIH0sXG4gIH07XG59XG5cbmZ1bmN0aW9uIHBhc3NEYXRhKHJhdzogc3RyaW5nKTogUGFyc2VNYXRyaXhSZXN1bHQge1xuICB0cnkge1xuICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHJhdyk7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGpzb24pKSB7XG4gICAgICByZXR1cm4gSXNOb3RWYWxpZCgpO1xuICAgIH1cblxuICAgIGNvbnN0IG1hdHJpeEVkZ2VMZW4gPSBNYXRoLnNxcnQoanNvbi5sZW5ndGgpO1xuICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihtYXRyaXhFZGdlTGVuKSkge1xuICAgICAgcmV0dXJuIElzTm90VmFsaWQoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaXNWYWxpZChjaHVuayhqc29uLCBtYXRyaXhFZGdlTGVuKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIElzTm90VmFsaWQoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXN0b3JlKG1hdHJpeDogTWF0cml4KTogTWF0cml4IHtcbiAgbGV0IHRvcCA9IDA7XG4gIGxldCByaWdodCA9IG1hdHJpeC5sZW5ndGggLSAxO1xuICBsZXQgYm90dG9tID0gbWF0cml4Lmxlbmd0aCAtIDE7XG4gIGxldCBsZWZ0ID0gMDtcblxuICBjb25zdCBvdXRwdXQgPSBBcnJheS5mcm9tKG1hdHJpeCwgKHIpID0+IEFycmF5LmZyb20ocikpO1xuXG4gIHdoaWxlIChsZWZ0IDwgcmlnaHQgJiYgdG9wIDwgYm90dG9tKSB7XG4gICAgbGV0IHByZXZpb3VzID0gbWF0cml4W3RvcCArIDFdIVtsZWZ0XSE7XG5cbiAgICBmb3IgKGxldCBpID0gbGVmdDsgaSA8PSByaWdodDsgaSsrKSB7XG4gICAgICBjb25zdCBjdXJyID0gbWF0cml4W3RvcF0hW2ldITtcbiAgICAgIG91dHB1dFt0b3BdIVtpXSA9IHByZXZpb3VzO1xuICAgICAgcHJldmlvdXMgPSBjdXJyO1xuICAgIH1cbiAgICB0b3ArKztcblxuICAgIGZvciAobGV0IGkgPSB0b3A7IGkgPD0gYm90dG9tOyBpKyspIHtcbiAgICAgIGNvbnN0IGN1cnIgPSBtYXRyaXhbaV0hW3JpZ2h0XSE7XG4gICAgICBvdXRwdXRbaV0hW3JpZ2h0XSA9IHByZXZpb3VzO1xuICAgICAgcHJldmlvdXMgPSBjdXJyO1xuICAgIH1cbiAgICByaWdodC0tO1xuXG4gICAgZm9yIChsZXQgaSA9IHJpZ2h0OyBpID49IGxlZnQ7IGkgLT0gMSkge1xuICAgICAgY29uc3QgY3VyciA9IG1hdHJpeFtib3R0b21dIVtpXSE7XG4gICAgICBvdXRwdXRbYm90dG9tXSFbaV0gPSBwcmV2aW91cztcbiAgICAgIHByZXZpb3VzID0gY3VycjtcbiAgICB9XG4gICAgYm90dG9tLS07XG5cbiAgICBmb3IgKGxldCBpID0gYm90dG9tOyBpID49IHRvcDsgaSAtPSAxKSB7XG4gICAgICBjb25zdCBjdXJyID0gbWF0cml4W2ldIVtsZWZ0XSE7XG4gICAgICBvdXRwdXRbaV0hW2xlZnRdID0gcHJldmlvdXM7XG4gICAgICBwcmV2aW91cyA9IGN1cnI7XG4gICAgfVxuICAgIGxlZnQrKztcbiAgfVxuXG4gIHJldHVybiBvdXRwdXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0Q1NWRmlsZShcbiAgc3RyZWFtOiBOb2RlSlMuUmVhZGFibGVTdHJlYW1cbik6IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSB7XG4gIGNvbnN0IHJsID0gY3JlYXRlSW50ZXJmYWNlKHtcbiAgICBpbnB1dDogc3RyZWFtLFxuICAgIGNybGZEZWxheTogSW5maW5pdHksXG4gIH0pO1xuXG4gIGNvbnN0IG91dFN0cmVhbSA9IG5ldyBQYXNzVGhyb3VnaCh7XG4gICAgZGVjb2RlU3RyaW5nczogZmFsc2UsXG4gICAgZW5jb2Rpbmc6IFwidXRmOFwiLFxuICAgIGRlZmF1bHRFbmNvZGluZzogXCJ1dGY4XCIsXG4gIH0pO1xuXG4gIGZ1bmN0aW9uIGdldExpbmUobGluZTogc3RyaW5nKSB7XG4gICAgY29uc3QgaW5kZXhPZkNvbW1hID0gbGluZS5pbmRleE9mKFwiLFwiKTtcbiAgICBjb25zdCBpZCA9IGxpbmUuc2xpY2UoMCwgaW5kZXhPZkNvbW1hKTtcbiAgICBjb25zdCBqc29uID0gbGluZS5zbGljZShpbmRleE9mQ29tbWEgKyAxKS5yZXBsYWNlQWxsKC9eXCJ8XCIkL2csIFwiXCIpO1xuICAgIGNvbnN0IHJlc3VsdCA9IHBhc3NEYXRhKGpzb24pLm1hcChyZXN0b3JlKS51bndyYXAoKTtcbiAgICBvdXRTdHJlYW0ud3JpdGUoXG4gICAgICBbaWQsIGBcIiR7cmVzdWx0Lmpzb259XCJgLCByZXN1bHQuaXNWYWxpZF0uam9pbihcIixcIilcbiAgICApO1xuICB9XG5cbiAgcmwub25jZShcImxpbmVcIiwgKCkgPT4ge1xuICAgIG91dFN0cmVhbS53cml0ZShcImlkLGpzb24saXNfdmFsaWRcIik7XG4gICAgcmwub24oXCJsaW5lXCIsIGdldExpbmUpO1xuICB9KTtcblxuICBybC5vbihcImNsb3NlXCIsICgpID0+IG91dFN0cmVhbS5lbmQoKSk7XG5cbiAgcmV0dXJuIG91dFN0cmVhbTtcbn1cbiJdfQ==